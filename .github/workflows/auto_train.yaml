name: Automated Training Pipeline

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly training
  workflow_dispatch:
    inputs:
      model_type:
        description: 'Model type (yolo, tabular, vision)'
        required: true
        default: 'yolo'
      dataset_version:
        description: 'Dataset version tag'
        required: true
      config_override:
        description: 'Config overrides (JSON)'
        required: false

permissions:
  contents: read

env:
  WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
  
jobs:
  prepare-data:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      data_hash: ${{ steps.data.outputs.hash }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
          
      - name: Validate dataset
        id: data
        run: |
          python scripts/validate_data.py --version ${{ inputs.dataset_version }}
          echo "hash=dummy_hash_$(date +%s)" >> $GITHUB_OUTPUT
          
  train:
    needs: prepare-data
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # For actual GPU training, use: runs-on: [self-hosted, gpu]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Setup environment
        run: |
          pip install -r requirements.txt
          pip install -r requirements-yolo.txt
          
      - name: Run training
        run: |
          python scripts/auto_train.py \
            --model ${{ inputs.model_type }} \
            --config configs/yolo_config.yaml \
            --data-version ${{ inputs.dataset_version }} \
            --experiment-name "auto-train-${{ github.run_id }}"
            
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-${{ github.run_id }}
          path: artifacts/models/
          
  evaluate:
    needs: train
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-yolo.txt
      
      - name: Download model
        uses: actions/download-artifact@v4
        with:
          name: model-${{ github.run_id }}
          path: artifacts/models/
        
      - name: Run evaluation
        run: |
          python scripts/evaluate.py \
            --model artifacts/models/yolo/weights/best.pt \
            --test-data data/test/ || echo "Evaluation skipped - no test data"
            
      - name: Generate report
        run: |
          python scripts/generate_report.py >> $GITHUB_STEP_SUMMARY
          
  deploy-staging:
    needs: evaluate
    if: success()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Download model
        uses: actions/download-artifact@v4
        with:
          name: model-${{ github.run_id }}
          path: artifacts/models/
      
      - name: Deploy to staging
        run: |
          python scripts/deploy.py \
            --env staging \
            --model artifacts/models/yolo/weights/best.pt || echo "Deployment skipped - configure deployment settings"
